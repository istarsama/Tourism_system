<!DOCTYPE html>
<html>
<head>
    <title>åœ°å›¾è·¯ç½‘æ„å»ºå™¨ v3.0 (æœ€ç»ˆç‰ˆ)</title>
    <style>
        body { display: flex; gap: 20px; padding: 20px; font-family: sans-serif; height: 100vh; overflow: hidden; }
        #left-panel { flex: 1; position: relative; border: 2px solid #333; overflow: auto; cursor: crosshair; }
        #map-image { display: block; user-select: none; pointer-events: none; } /* å›¾ç‰‡ä¸æ‹¦æˆªç‚¹å‡» */
        
        .dot { 
            position: absolute; width: 10px; height: 10px; 
            background: #007bff; border: 2px solid white; border-radius: 50%; 
            transform: translate(-7px, -7px); cursor: pointer;
            z-index: 10; box-shadow: 0 0 2px rgba(0,0,0,0.5);
        }
        .dot:hover { transform: translate(-7px, -7px) scale(1.2); z-index: 11; }
        .dot.selected { background: #ff0000; box-shadow: 0 0 0 4px rgba(255, 0, 0, 0.3); z-index: 12; }
        .dot.spot { background: #28a745; } /* æ™¯ç‚¹æ˜¯ç»¿è‰²çš„ */
        
        svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
        line { stroke: #ff0000; stroke-width: 3; stroke-opacity: 0.6; }
        
        #sidebar { width: 320px; display: flex; flex-direction: column; gap: 15px; padding-right: 10px; }
        .control-group { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #ddd; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 12px; color: #666; }
        input[type="text"] { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        textarea { width: 100%; flex: 1; font-family: monospace; font-size: 11px; }
        button { padding: 10px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        
        .status-bar { padding: 5px 10px; background: #e9ecef; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>
    <div id="left-panel">
        <svg id="lines"></svg>
        <div id="dots-layer"></div>
        <img id="map-image" src="map1.jpg"> 
    </div>
    
    <div id="sidebar">
        <h3>ğŸ“ è·¯ç½‘æ„å»ºå™¨ v3.0</h3>
        
        <div class="control-group">
            <label>å½“å‰é€‰ä¸­èŠ‚ç‚¹ ID: <span id="current-id">-</span></label>
            <label>åç§° (åœ¨è¿™é‡Œä¿®æ”¹ä¸ä¼šä¸¢å¤±):</label>
            <input type="text" id="node-name" placeholder="é€‰ä¸­ç‚¹ååœ¨æ­¤æ”¹å..." disabled>
            
            <div style="margin-top:10px; display:flex; gap:5px;">
                <button onclick="toggleSpot()" style="flex:1; background:#28a745">è®¾ä¸ºæ™¯ç‚¹ (S)</button>
                <button onclick="deleteNode()" class="danger" style="width:40px" title="åˆ é™¤">ğŸ—‘ï¸</button>
            </div>
        </div>

        <div class="status-bar">
            <strong>æ“ä½œå£è¯€ï¼š</strong><br>
            1. ğŸ–±ï¸ <b>ç‚¹ç©ºç™½</b> = æ–°å»ºå¹¶è¿æ¥<br>
            2. ğŸ”— <b>ç‚¹è“ç‚¹</b> = è¿æ¥å·²æœ‰ä¸¤ç‚¹<br>
            3. ğŸ“ <b>æ”¹å</b> = åœ¨ä¸Šæ–¹è¾“å…¥æ¡†ä¿®æ”¹<br>
            4. âŒ¨ï¸ <b>Ctrl+Z</b> = æ’¤é”€<br>
        </div>

        <textarea id="output" readonly placeholder="JSON ä¼šè‡ªåŠ¨ç”Ÿæˆåœ¨è¿™é‡Œ..."></textarea>
        <button onclick="copyJSON()">å¤åˆ¶ JSON</button>
    </div>

    <script>
        // æ•°æ®å­˜å‚¨
        let state = {
            spots: [],
            edges: [],
            nextId: 1,
            selectedId: null
        };

        // å†å²è®°å½• (ç”¨äºæ’¤é”€)
        let historyStack = [];

        const ui = {
            panel: document.getElementById('left-panel'),
            dotsLayer: document.getElementById('dots-layer'),
            svg: document.getElementById('lines'),
            nameInput: document.getElementById('node-name'),
            idLabel: document.getElementById('current-id'),
            output: document.getElementById('output')
        };

        // ================= æ ¸å¿ƒé€»è¾‘ =================

        // 1. ç‚¹å‡»é¢æ¿ (ç©ºç™½å¤„) -> æ–°å»ºç‚¹
        ui.panel.addEventListener('click', (e) => {
            if (e.target !== ui.panel && e.target.id !== 'map-image') return; // å¿½ç•¥ç‚¹å‡»ç‚¹
            saveHistory();
            
            const rect = ui.panel.getBoundingClientRect();
            // è®¡ç®—ç›¸å¯¹äºå›¾ç‰‡çš„åæ ‡ï¼ˆè€ƒè™‘æ»šåŠ¨ï¼‰
            const x = Math.round(e.clientX - rect.left + ui.panel.scrollLeft);
            const y = Math.round(e.clientY - rect.top + ui.panel.scrollTop);

            createNode(x, y);
        });

        // 2. åˆ›å»ºèŠ‚ç‚¹
        function createNode(x, y) {
            const id = state.nextId++;
            const newNode = {
                id: id,
                name: `è·¯ç‚¹_${id}`,
                x: x, 
                y: y,
                type: 'road'
            };
            state.spots.push(newNode);

            // å¦‚æœæœ‰é€‰ä¸­ç‚¹ï¼Œè‡ªåŠ¨è¿æ¥
            if (state.selectedId !== null) {
                createEdge(state.selectedId, id);
            }

            render();
            selectNode(id);
        }

        // 3. ç‚¹å‡»å·²æœ‰èŠ‚ç‚¹ (é€‰ä¸­ æˆ– è¿æ¥)
        function onDotClick(e, id) {
            e.stopPropagation(); // é˜»æ­¢å†’æ³¡åˆ°é¢æ¿
            
            // å¦‚æœç‚¹å‡»çš„æ˜¯å½“å‰é€‰ä¸­çš„ç‚¹ -> å–æ¶ˆé€‰ä¸­
            if (state.selectedId === id) {
                selectNode(null);
                return;
            }

            // å¦‚æœå·²ç»é€‰ä¸­äº†ä¸€ä¸ªç‚¹ Aï¼Œç°åœ¨ç‚¹å‡»äº†ç‚¹ B -> å»ºç«‹è¿æ¥ (é—­ç¯)
            if (state.selectedId !== null) {
                saveHistory();
                // æ£€æŸ¥æ˜¯å¦å·²ç»è¿è¿‡äº†
                const exists = state.edges.some(edge => 
                    (edge.u === state.selectedId && edge.v === id) || 
                    (edge.u === id && edge.v === state.selectedId)
                );
                
                if (!exists) {
                    createEdge(state.selectedId, id);
                    render();
                }
                // è¿å®Œåï¼Œç„¦ç‚¹è½¬ç§»åˆ°æ–°ç‚¹çš„ç‚¹ä¸Šï¼Œæ–¹ä¾¿ç»§ç»­èµ°
                selectNode(id); 
            } else {
                // å¦‚æœæ²¡é€‰ä¸­ç‚¹ -> é€‰ä¸­å®ƒ
                selectNode(id);
            }
        }

        // 4. åˆ›å»ºè¾¹
        function createEdge(uId, vId) {
            const u = state.spots.find(s => s.id === uId);
            const v = state.spots.find(s => s.id === vId);
            if (!u || !v) return;

            const dist = Math.round(Math.sqrt(Math.pow(u.x - v.x, 2) + Math.pow(u.y - v.y, 2)));
            state.edges.push({
                u: uId,
                v: vId,
                distance: dist,
                crowding: 1.0
            });
        }

        // 5. é€‰ä¸­é€»è¾‘ & æ”¹åç»‘å®š
        function selectNode(id) {
            state.selectedId = id;
            renderVisualSelection();

            if (id === null) {
                ui.nameInput.value = '';
                ui.nameInput.disabled = true;
                ui.idLabel.textContent = '-';
            } else {
                const node = state.spots.find(s => s.id === id);
                ui.nameInput.value = node.name;
                ui.nameInput.disabled = false;
                ui.idLabel.textContent = id;
                ui.nameInput.focus(); // è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
            }
        }

        // ç›‘å¬è¾“å…¥æ¡†ä¿®æ”¹ï¼Œå®æ—¶åŒæ­¥åˆ°æ•°æ®
        ui.nameInput.addEventListener('input', (e) => {
            if (state.selectedId === null) return;
            const node = state.spots.find(s => s.id === state.selectedId);
            if (node) {
                node.name = e.target.value;
                exportJSON(); // å®æ—¶æ›´æ–° JSON
            }
        });

        // ================= æ¸²æŸ“é€»è¾‘ =================
        function render() {
            // 1. æ¸…ç©ºç”»å¸ƒ
            ui.dotsLayer.innerHTML = '';
            ui.svg.innerHTML = '';

            // 2. ç”»çº¿ (Edge)
            state.edges.forEach(edge => {
                const u = state.spots.find(s => s.id === edge.u);
                const v = state.spots.find(s => s.id === edge.v);
                if (u && v) drawLine(u, v);
            });

            // 3. ç”»ç‚¹ (Node)
            state.spots.forEach(spot => {
                const dot = document.createElement('div');
                dot.className = `dot ${spot.type === 'spot' ? 'spot' : ''}`;
                dot.style.left = `${spot.x}px`;
                dot.style.top = `${spot.y}px`;
                dot.onclick = (e) => onDotClick(e, spot.id);
                ui.dotsLayer.appendChild(dot);
            });

            renderVisualSelection();
            exportJSON();
        }

        function drawLine(u, v) {
            const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
            line.setAttribute("x1", u.x);
            line.setAttribute("y1", u.y);
            line.setAttribute("x2", v.x);
            line.setAttribute("y2", v.y);
            ui.svg.appendChild(line);
        }

        function renderVisualSelection() {
            // ç§»é™¤æ—§é€‰ä¸­
            document.querySelectorAll('.dot.selected').forEach(el => el.classList.remove('selected'));
            // æ·»åŠ æ–°é€‰ä¸­
            if (state.selectedId !== null) {
                // è¿™é‡Œçš„ç´¢å¼•å¯èƒ½ä¸å‡†ï¼Œä¾èµ– DOM é¡ºåºé‡ç»˜æœ‰ç‚¹æµªè´¹ï¼Œç®€å•å¤„ç†ï¼š
                // é‡æ–°æŸ¥æ‰¾æ‰€æœ‰ç‚¹å¯¹åº”çš„ DOM (ç”±äºrenderé‡ç»˜äº†ï¼Œè¿™é‡Œç¨å¾®ç®€é™‹ç‚¹ä½†æœ‰æ•ˆ)
                const index = state.spots.findIndex(s => s.id === state.selectedId);
                if (index >= 0 && ui.dotsLayer.children[index]) {
                    ui.dotsLayer.children[index].classList.add('selected');
                }
            }
        }

        // ================= å·¥å…·å‡½æ•° =================
        function toggleSpot() {
            if (state.selectedId === null) return;
            saveHistory();
            const node = state.spots.find(s => s.id === state.selectedId);
            node.type = node.type === 'road' ? 'spot' : 'road';
            render();
            // ä¿æŒé€‰ä¸­çŠ¶æ€
            selectNode(node.id);
        }

        function deleteNode() {
            if (state.selectedId === null) return;
            saveHistory();
            const id = state.selectedId;
            // åˆ ç‚¹
            state.spots = state.spots.filter(s => s.id !== id);
            // åˆ è¾¹
            state.edges = state.edges.filter(e => e.u !== id && e.v !== id);
            
            selectNode(null);
            render();
        }

        function exportJSON() {
            ui.output.value = JSON.stringify({ spots: state.spots, edges: state.edges }, null, 2);
        }

        function copyJSON() {
            ui.output.select();
            document.execCommand('copy');
            alert('JSON å·²å¤åˆ¶ï¼å¿«å»è¦†ç›– campus_map.json');
        }

        // æ’¤é”€åŠŸèƒ½
        function saveHistory() {
            // æ·±æ‹·è´å½“å‰çŠ¶æ€
            historyStack.push(JSON.parse(JSON.stringify(state)));
            if (historyStack.length > 20) historyStack.shift(); // é™åˆ¶æ­¥æ•°
        }

        document.addEventListener('keydown', (e) => {
            // Ctrl+Z æ’¤é”€
            if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                e.preventDefault();
                if (historyStack.length > 0) {
                    state = historyStack.pop();
                    render();
                    selectNode(state.selectedId);
                }
            }
            // S é”®è®¾ä¸ºæ™¯ç‚¹ (å½“æ²¡æœ‰åœ¨è¾“å…¥æ¡†æ‰“å­—æ—¶)
            if (e.key.toLowerCase() === 's' && document.activeElement !== ui.nameInput) {
                toggleSpot();
            }
            // Delete é”®åˆ é™¤
            if (e.key === 'Delete' && document.activeElement !== ui.nameInput) {
                deleteNode();
            }
        });

        // åˆå§‹åŒ–
        render();
    </script>
</body>
</html>