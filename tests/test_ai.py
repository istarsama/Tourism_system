import requests
import json

BASE_URL = "http://127.0.0.1:8000"

def test_scenario(name, question, expected_keyword_in_source):
    """
    ä¸€ä¸ªé€šç”¨çš„æµ‹è¯•å‡½æ•°ï¼Œç”¨æ¥æµ‹ä¸åŒçš„åœºæ™¯
    """
    print(f"\nğŸ§ª [æµ‹è¯•åœºæ™¯] {name}")
    print(f"   â“ æé—®: {question}")
    
    try:
        # å‘é€è¯·æ±‚
        res = requests.post(f"{BASE_URL}/ai/rag_chat", json={"message": question})
        
        if res.status_code == 200:
            data = res.json()
            reply = data.get('reply', '')
            source = data.get('source', 'æœªçŸ¥æ¥æº')
            
            # æ‰“å°ç»“æœ
            print(f"   ğŸ¤– AI å›å¤: {reply[:60]}...") # åªæ‰“å°å‰60ä¸ªå­—é¿å…åˆ·å±
            print(f"   ğŸ“œ å®é™…æ¥æº: {source}")
            
            # éªŒè¯æ¥æºæ˜¯å¦ç¬¦åˆé¢„æœŸ
            if expected_keyword_in_source in source:
                print(f"   âœ… æµ‹è¯•é€šè¿‡ï¼æˆåŠŸè¯†åˆ«æ„å›¾ã€‚")
            else:
                print(f"   âš ï¸ è­¦å‘Š: æ¥æºä¸ç¬¦ (é¢„æœŸåŒ…å« '{expected_keyword_in_source}')")
        else:
            print(f"   âŒ è¯·æ±‚å¤±è´¥: {res.text}")
            
    except Exception as e:
        print(f"   âŒ è¿æ¥é”™è¯¯: {e}")

def main():
    print("ğŸ¤– å¼€å§‹å…¨èƒ½ AI å¯¼æ¸¸æµ‹è¯• (æ•°æ®åº“ + è”ç½‘ + é—²èŠ)...")
    print("(è¯·ç¡®ä¿åç«¯å·²é‡å¯ï¼Œä¸” .env é‡Œé…ç½®äº† DEEPSEEK_API_KEY å’Œ TAVILY_API_KEY)")

    # ---------------------------------------------------------
    # åœºæ™¯ 1: çº¯é—²èŠ (åº”è¯¥ç›´æ¥å›ç­”ï¼Œä¸æŸ¥ä»»ä½•ä¸œè¥¿)
    # ---------------------------------------------------------
    test_scenario(
        name="çº¯é—²èŠæ¨¡å¼",
        question="ä½ å¥½å‘€ï¼Œç»™æˆ‘è®²ä¸ªå†·ç¬‘è¯",
        expected_keyword_in_source="AIé—²èŠ"
    )

    # ---------------------------------------------------------
    # åœºæ™¯ 2: æŸ¥æœ¬åœ°æ•°æ®åº“ (åº”è¯¥æŸ¥ MySQL æ—¥è®°)
    # ---------------------------------------------------------
    # åªè¦ä½ è¿è¡Œè¿‡ import_data.pyï¼Œåº“é‡Œå°±æœ‰å…³äº"é£Ÿå ‚"çš„æ•°æ®
    test_scenario(
        name="RAG æŸ¥åº“æ¨¡å¼",
        question="æ ¹æ®åŒå­¦ä»¬çš„åé¦ˆï¼Œå­¦ç”Ÿé£Ÿå ‚çš„é¥­æ€ä¹ˆæ ·ï¼Ÿ",
        expected_keyword_in_source="æœ¬åœ°æ•°æ®åº“"
    )

    # ---------------------------------------------------------
    # åœºæ™¯ 3: æŸ¥äº’è”ç½‘ (åº”è¯¥è°ƒç”¨ Tavily)
    # ---------------------------------------------------------
    # é—®ä¸€ä¸ªåº“é‡Œç»å¯¹æ²¡æœ‰ã€ä¸”å…·æœ‰æ—¶æ•ˆæ€§çš„é—®é¢˜
    test_scenario(
        name="è”ç½‘æœç´¢æ¨¡å¼",
        question="åŒ—äº¬æ˜å¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿé€‚åˆç©¿ä»€ä¹ˆè¡£æœï¼Ÿ",
        expected_keyword_in_source="äº’è”ç½‘æœç´¢"
    )

if __name__ == "__main__":
    main()